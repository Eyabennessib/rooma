<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Roomate ‚Äì Rotations</title>
<style>
  :root{
    --bg:#fff6fb; --card:#ffffff; --text:#2b2b2b; --muted:#5c5c5c; --border:#f1c4ff;
    --accent:#ff6ec7; --accent2:#ffd166; --accent3:#06d6a0; --accent4:#ff8c42; --accent5:#7b61ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Arial; color:var(--text);
    background:
      radial-gradient(600px 300px at 10% 0%, #ffe6fa 20%, transparent 70%),
      radial-gradient(700px 350px at 90% 10%, #f3e8ff 20%, transparent 70%),
      var(--bg); min-height:100vh;
  }
  /* Stickers */
  .stickers{position:fixed; inset:0; pointer-events:none; opacity:.15; z-index:0;
    background-image:
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 64 64'><path fill='%23ff6ec7' d='M20 30c-6-8 4-18 12-16 7 2 10 12 3 18-6 5-15 3-15-2z'/></svg>"),
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 64 64'><path fill='%2306d6a0' d='M8 40c8-10 22-10 30 0 2 3-1 8-6 8H14c-5 0-8-5-6-8z'/></svg>"),
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 64 64'><rect x='10' y='24' width='44' height='20' rx='4' fill='%23ffd166'/><rect x='14' y='28' width='36' height='12' rx='2' fill='%23fff2c2'/></svg>"),
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 64 64'><path fill='%23ff8c42' d='M12 44h40l-3-12H15l-3 12z'/><rect x='18' y='20' width='28' height='12' rx='2' fill='%23ffd1b2'/></svg>"),
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 64 64'><rect x='8' y='26' width='48' height='16' rx='6' fill='%237b61ff'/><rect x='12' y='18' width='40' height='8' rx='3' fill='%23b6a6ff'/></svg>");
    background-size:160px; background-repeat:repeat; background-position:0 0, 80px 120px, 40px 240px, 120px 360px, 200px 60px;
  }
  header{position:sticky; top:0; z-index:2; backdrop-filter: blur(8px); background: rgba(255,255,255,.7);
    border-bottom: 2px solid var(--border); padding:14px 18px; display:flex; align-items:center; gap:12px; justify-content:space-between;}
  .title{font-size:24px; font-weight:800}
  .lang button{border:2px solid var(--border); background:#fff; color:#3d3d3d; padding:6px 10px; border-radius:999px; cursor:pointer}
  .lang .active{border-color:var(--accent); color:#111}
  main{padding:18px; position:relative; z-index:1}
  .grid{display:grid; gap:16px; grid-template-columns: repeat(auto-fit,minmax(280px,1fr))}
  .card{background:#fff; border:2px solid var(--border); border-radius:18px; padding:14px;
    box-shadow: 0 8px 20px rgba(123,97,255,0.12), 0 4px 10px rgba(255,110,199,0.08);}
  h3{margin:6px 0 10px 0; font-size:16px}
  .muted{color:var(--muted); font-size:12px}
  input, button, select{width:100%; padding:10px 12px; border-radius:12px; border:2px solid var(--border); background:#fff; outline:none}
  input:focus, select:focus{border-color:var(--accent5)}
  button{cursor:pointer; font-weight:700}
  .primary{background: linear-gradient(90deg, var(--accent), var(--accent5), var(--accent2)); color:#111; border-color:transparent}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  table{width:100%; border-collapse:collapse; margin-top:8px}
  th, td{border-bottom:2px solid var(--border); padding:8px; font-size:14px; text-align:left}
  .chip{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef; border:1px solid var(--border)}
  .chip.done{background:#e6fff5; border-color:#b7f7df}
  .toolbar{display:flex; gap:8px; margin-top:6px}
  .tiny{padding:6px 8px; font-size:12px}
  .toast{position:fixed; right:12px; bottom:12px; background:#111; color:#fff; padding:10px 12px; border-radius:10px; opacity:.95; display:none}
</style>
</head>
<body>
<div class="stickers"></div>

<header>
  <div class="title">Roomate</div>
  <div class="lang">
    <button id="lang-fr" class="active">FR</button>
    <button id="lang-en">EN</button>
  </div>
</header>

<main>
  <!-- Household selector + actions -->
  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <select id="houseSelect" style="flex:1"></select>
      <div class="toolbar">
        <button id="useHouse" class="tiny">Utiliser</button>
        <button id="renameHouse" class="tiny">Renommer</button>
        <button id="deleteHouse" class="tiny" style="background:#ffe2e2;border-color:#ffc8c8">Supprimer</button>
      </div>
    </div>
    <div id="houseInfo" class="muted" style="margin-top:6px">‚Äî</div>
  </div>

  <div class="grid">
    <!-- Create household -->
    <div class="card">
      <h3 data-i="createHouse">Cr√©er une colocation</h3>
      <input id="houseName" placeholder="Appartement Massy"/>
      <button id="createHouse" class="primary" data-i="create">Cr√©er</button>
      <div class="muted" data-i="houseHelp">Donnez-lui un nom court (ex: Appart 12B).</div>
    </div>

    <!-- Members -->
    <div class="card">
      <h3 data-i="addMember">Ajouter un membre</h3>
      <input id="memberName" placeholder="Nom"/>
      <div class="row" style="width:100%">
        <input id="memberEmail" placeholder="Email (optionnel)" style="flex:1"/>
        <button id="addMember" style="min-width:120px">Ajouter</button>
      </div>
      <ul id="membersList" style="list-style:none; padding-left:0; margin:8px 0 0 0" class="muted"></ul>
    </div>

    <!-- Chores -->
    <div class="card">
      <h3 data-i="addChore">Ajouter une t√¢che</h3>
      <div class="row" style="width:100%">
        <input id="choreTitle" placeholder="Cuisine, Salle de bain‚Ä¶"/>
        <button id="addChore" style="min-width:120px">Ajouter</button>
      </div>
      <ul id="choresList" style="list-style:none; padding-left:0; margin:8px 0 0 0" class="muted"></ul>
    </div>

    <!-- Rotation -->
    <div class="card">
      <h3>G√©n√©rer la rotation hebdomadaire</h3>
      <div class="row" style="width:100%">
        <input id="weekStart" type="date" inputmode="numeric" pattern="\\d{4}-\\d{2}-\\d{2}" placeholder="YYYY-MM-DD" style="flex:1"/>
        <button id="btnThisWeek" class="tiny" title="Mettre le lundi de cette semaine">Cette semaine</button>
        <button id="rotate" class="primary">Cr√©er les affectations</button>
      </div>
      <div class="muted">Utilise ‚ÄúCette semaine‚Äù si le s√©lecteur de date ne marche pas.</div>
    </div>
  </div>

  <!-- Assignments -->
  <div class="card" style="margin-top:12px">
    <h3>Affectations de la semaine</h3>
    <div class="row">
      <input id="filterWeek" type="date" inputmode="numeric" pattern="\\d{4}-\\d{2}-\\d{2}" placeholder="YYYY-MM-DD" />
      <button id="load">Charger</button>
    </div>
    <table>
      <thead>
        <tr><th>T√¢che</th><th>Assign√© √†</th><th>Statut</th><th>Preuve</th><th>Action</th></tr>
      </thead>
      <tbody id="assignBody"></tbody>
    </table>
  </div>
</main>

<div id="toast" class="toast"></div>

<script>
const API = "http://127.0.0.1:5000/api";

/* i18n */
const dict = {
  fr:{created:"Colocation cr√©√©e.", memberAdded:"Membre ajout√©.", choreAdded:"T√¢che ajout√©e.", loaded:"Affectations charg√©es.",
      generated:"Affectations cr√©√©es.", noHouse:"S√©lectionnez une colocation.", confirmDelete:"Supprimer cette colocation ?"},
  en:{created:"Household created.", memberAdded:"Member added.", choreAdded:"Chore added.", loaded:"Assignments loaded.",
      generated:"Assignments created.", noHouse:"Select a household.", confirmDelete:"Delete this household?"}
};
let lang = localStorage.getItem("roomate_lang") || "fr";
function t(k){ return (dict[lang]||dict.fr)[k] || k; }
document.getElementById("lang-fr").onclick=()=>{lang="fr";localStorage.setItem("roomate_lang","fr");location.reload();}
document.getElementById("lang-en").onclick=()=>{lang="en";localStorage.setItem("roomate_lang","en");location.reload();}

/* helpers */
function toast(msg){ const el=document.getElementById("toast"); el.textContent=msg; el.style.display="block"; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display="none",2000); }
function isoMonday(d){ const dt=d?new Date(d):new Date(); const day=dt.getDay(); const diff=(day===0?-6:1)-day; const m=new Date(dt); m.setDate(dt.getDate()+diff); m.setHours(0,0,0,0); return m.toISOString().slice(0,10); }
async function api(path, opts={}){ const res=await fetch(API+path, Object.assign({headers:{'Content-Type':'application/json'}}, opts)); if(!res.ok){ let msg="Error"; try{msg=(await res.json()).error||msg;}catch{}; throw new Error(msg);} return res.json(); }
function li(text, delCb){ const el=document.createElement("li"); el.style.marginTop="6px"; el.innerHTML=text; if(delCb){ const b=document.createElement("button"); b.textContent="üóë"; b.className="tiny"; b.style.marginLeft="8px"; b.onclick=delCb; el.appendChild(b);} return el; }

/* state */
let householdId = Number(localStorage.getItem("roomate_active")) || null;

/* elements */
const houseSelect=document.getElementById("houseSelect"), houseInfo=document.getElementById("houseInfo");
const membersList=document.getElementById("membersList"), choresList=document.getElementById("choresList"), assignBody=document.getElementById("assignBody");

/* date defaults */
function setThisWeek(){ document.getElementById("weekStart").value=isoMonday(); document.getElementById("filterWeek").value=isoMonday(); }
document.getElementById("btnThisWeek").onclick=setThisWeek; setThisWeek();

/* load houses */
async function loadHouseList(){
  const list=await api("/households");
  houseSelect.innerHTML=list.households.map(h=>`<option value="${h.id}">#${h.id} ‚Äì ${h.name}</option>`).join("") || `<option value="">‚Äî</option>`;
  if(householdId && [...houseSelect.options].some(o=>Number(o.value)===householdId)) houseSelect.value=String(householdId);
  await refreshActive();
}

/* refresh active view */
async function refreshActive(){
  if(!householdId){ houseInfo.textContent="‚Äî"; membersList.innerHTML=""; choresList.innerHTML=""; assignBody.innerHTML=""; return; }
  const d=await api(`/households/${householdId}`);
  houseInfo.textContent=`#${d.household.id} ‚Äì ${d.household.name}`;
  membersList.innerHTML=""; d.members.forEach(m=>membersList.appendChild(li(`${m.name}${m.email? " ‚Äî "+m.email:""}`, async()=>{await api(`/households/${householdId}/members/${m.id}`,{method:"DELETE"}); await refreshActive();})));
  if(d.members.length===0) membersList.innerHTML="<li class='muted'>‚Äî</li>";
  choresList.innerHTML=""; d.chores.forEach(c=>choresList.appendChild(li(c.title, async()=>{await api(`/households/${householdId}/chores/${c.id}`,{method:"DELETE"}); await refreshActive();})));
  if(d.chores.length===0) choresList.innerHTML="<li class='muted'>‚Äî</li>";
}

/* actions */
document.getElementById("useHouse").onclick=async()=>{ const id=Number(houseSelect.value); if(!id) return; householdId=id; localStorage.setItem("roomate_active",String(id)); await refreshActive(); toast("OK"); };
document.getElementById("renameHouse").onclick=async()=>{ if(!householdId) return toast(t("noHouse")); const name=prompt(lang==="fr"?"Nouveau nom ?":"New name?"); if(!name) return; await api(`/households/${householdId}`,{method:"PUT", body:JSON.stringify({name})}); await loadHouseList(); };
document.getElementById("deleteHouse").onclick=async()=>{ if(!householdId) return; if(!confirm(t("confirmDelete"))) return; await api(`/households/${householdId}`,{method:"DELETE"}); householdId=null; localStorage.removeItem("roomate_active"); await loadHouseList(); };

document.getElementById("createHouse").onclick=async()=>{ const name=document.getElementById("houseName").value.trim(); if(!name) return;
  const d=await api("/households",{method:"POST", body:JSON.stringify({name})}); householdId=d.id; localStorage.setItem("roomate_active",String(d.id));
  document.getElementById("houseName").value=""; await loadHouseList(); toast(t("created")); };

document.getElementById("addMember").onclick=async()=>{ if(!householdId) return toast(t("noHouse"));
  const name=document.getElementById("memberName").value.trim(); if(!name) return;
  const email=document.getElementById("memberEmail").value.trim()||null; await api(`/households/${householdId}/members`,{method:"POST", body:JSON.stringify({name,email})});
  document.getElementById("memberName").value=""; document.getElementById("memberEmail").value=""; await refreshActive(); toast(t("memberAdded")); };

document.getElementById("addChore").onclick=async()=>{ if(!householdId) return toast(t("noHouse"));
  const title=document.getElementById("choreTitle").value.trim(); if(!title) return;
  await api(`/households/${householdId}/chores`,{method:"POST", body:JSON.stringify({title})}); document.getElementById("choreTitle").value="";
  await refreshActive(); toast(t("choreAdded")); };

document.getElementById("rotate").onclick=async()=>{ if(!householdId) return toast(t("noHouse"));
  const ws=document.getElementById("weekStart").value || isoMonday(); await api(`/households/${householdId}/rotate`,{method:"POST", body:JSON.stringify({week_start:ws})});
  await loadAssignments(); toast(t("generated")); };

document.getElementById("load").onclick=loadAssignments;
async function loadAssignments(){
  if(!householdId) return toast(t("noHouse"));
  const ws = document.getElementById("filterWeek").value || isoMonday();
  const d  = await api(`/households/${householdId}/assignments/current?week_start=${ws}`);

  assignBody.innerHTML = d.assignments.map(a=>{
    const badge = a.status === "done" ? "<span class='chip done'>done</span>" : "<span class='chip'>assign√©</span>";
    return `
      <tr>
        <td>${a.chore_title}</td>
        <td>${a.member_name}</td>
        <td>${badge}</td>
        <td>${a.proof_url ? `<a href='${a.proof_url}' target='_blank'>lien</a>` : ""}</td>
        <td>
          ${a.status === "assigned"
            ? `<div class="row">
                 <input class="proof" data-id="${a.id}" placeholder="URL">
                 <button class="tiny complete" data-id="${a.id}">Terminer</button>
               </div>`
            : ""}
        </td>
      </tr>`;
  }).join("") || `<tr><td colspan="5" class="muted">‚Äî</td></tr>`;

  // wire up complete buttons
  document.querySelectorAll(".complete").forEach(btn=>{
    btn.onclick = async ()=>{
      const id    = btn.getAttribute("data-id");
      const proof = document.querySelector(`.proof[data-id="${id}"]`)?.value || "";
      const res   = await fetch(`${API}/assignments/${id}/complete`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({proof_url: proof})
      });
      if (!res.ok){ toast("Error"); return; }
      await loadAssignments();
    };
  });
}

// boot
loadHouseList().catch(err => toast(err.message));
</script>
</body>
</html>